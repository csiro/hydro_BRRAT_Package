source("C:/code/BRRAT/R/BRRAT.R", echo=TRUE)
Clim <- sort(pmax(0,rnorm(30,600,100))) #generate some annual rainfall totals
Obs <- pmax(0,(Clim - 150) - 450 * tanh((Clim - 150)/450)) #calculate annual runoff from tanh curve
Sim <- Obs*seq(1,0.7,length.out=length(Obs))*rnorm(30,1,0.05) #underestimate the wetter years
Sim2 <- Obs*rnorm(100,1,0.05) #random error
slopes <- BRRAT(Sim,Obs,Clim)
samples <- 30
Clim <- sort(pmax(0,rnorm(samples,600,100))) #generate some annual rainfall totals
Obs <- pmax(0,(Clim - 150) - 450 * tanh((Clim - 150)/450)) #calculate annual runoff from tanh curve
Sim1 <- Obs*seq(1,0.7,length.out=length(Obs))*rnorm(samples,1,0.05) #non-robust model, underestimate the wetter years
Sim2 <- Obs*rnorm(samples,1,0.05) #robust model, only random error
slopes1 <- BRRAT(Sim1,Obs,Clim)
if(length(Sim)!=length(Obs) | length(Sim)!=length(Clim)) stop("length of input vectors must be the same")
if(any(is.na(Sim)) | any(is.na(Obs)) | any(is.na(Clim))) stop("remove NAs")
if(min(Obs)<0) stop("Obs must be positive")
#find lambda for box-cox transformation
lambda <- 1
out <- MASS::boxcox(lm(Obs~1), plotit=FALSE)
range <- range(out$x[out$y > max(out$y)-qchisq(0.95,1)/2])
#if 1 is outside the 95% confidence interval of the best lambda, then transform.
#Assumes already near normal if 1 is in the range
if(min(range)>1 | max(range<1)){
lambda <- out$x[which.max(out$y)]
Obs <- (Obs^lambda - 1) / lambda
Sim <- (Sim^lambda - 1) / lambda
if(!is.null(Sim2)) Sim2 <- (Sim2^lambda - 1) / lambda
}
Qerr <- Sim/Obs - 1
Clim_Index <- Clim/mean(Clim) - 1
stan_data <- list(
N = length(Obs),
x = Clim_Index,
y = Qerr
)
fit <- rstan::sampling(stanmodels$lm, data = stan_data, ...)
fit <- rstan::sampling(stanmodels$lm, data = stan_data)
stanmodels
try(roxygen2::roxygenize(load_code = rstantools_load_code), silent = TRUE)
roxygen2::roxygenize()
roxygen2::roxygenize()
roxygen2::roxygenize()
roxygen2::roxygenize()
install.packages("../BRRAT", repos = NULL, type = "source")
install.packages("../BRRAT", repos = NULL, type = "source")
library(BRRAT)
' samples <- 30
Clim <- sort(pmax(0,rnorm(samples,600,100))) #generate some annual rainfall totals
Obs <- pmax(0,(Clim - 150) - 450 * tanh((Clim - 150)/450)) #calculate annual runoff from tanh curve
Sim1 <- Obs*seq(1,0.7,length.out=length(Obs))*rnorm(samples,1,0.05) #non-robust model, underestimate the wetter years
Sim2 <- Obs*rnorm(samples,1,0.05) #robust model, only random error
slopes1 <- BRRAT(Sim1,Obs,Clim)
samples <- 30
Clim <- sort(pmax(0,rnorm(samples,600,100))) #generate some annual rainfall totals
Obs <- pmax(0,(Clim - 150) - 450 * tanh((Clim - 150)/450)) #calculate annual runoff from tanh curve
Sim1 <- Obs*seq(1,0.7,length.out=length(Obs))*rnorm(samples,1,0.05) #non-robust model, underestimate the wetter years
Sim2 <- Obs*rnorm(samples,1,0.05) #robust model, only random error
slopes1 <- BRRAT(Sim1,Obs,Clim)
slopes1
slopes2 <- BRRAT(Sim2,Obs,Clim)
slopes2
if(length(Sim)!=length(Obs) | length(Sim)!=length(Clim)) stop("length of input vectors must be the same")
Sim<-Sim2
if(length(Sim)!=length(Obs) | length(Sim)!=length(Clim)) stop("length of input vectors must be the same")
if(any(is.na(Sim)) | any(is.na(Obs)) | any(is.na(Clim))) stop("remove NAs")
if(min(Obs)<0) stop("Obs must be positive")
#find lambda for box-cox transformation
lambda <- 1
out <- MASS::boxcox(lm(Obs~1), plotit=FALSE)
range <- range(out$x[out$y > max(out$y)-qchisq(0.95,1)/2])
#if 1 is outside the 95% confidence interval of the best lambda, then transform.
#Assumes already near normal if 1 is in the range
if(min(range)>1 | max(range<1)){
lambda <- out$x[which.max(out$y)]
Obs <- (Obs^lambda - 1) / lambda
Sim <- (Sim^lambda - 1) / lambda
if(!is.null(Sim2)) Sim2 <- (Sim2^lambda - 1) / lambda
}
Qerr <- Sim/Obs - 1
Clim_Index <- Clim/mean(Clim) - 1
plot(Clim_Index,Qerr)
lm(Clim_Index~Qerr)
lm(Qerr,Clim_Index)
lm(Qerr~Clim_Index)
slopes2
slopes1
slopes1[["fit"]]
slopes2[["fit"]]
library(bayesplot)
document()
try(roxygen2::roxygenize(load_code = rstantools_load_code), silent = TRUE)
roxygen2::roxygenize()
install.packages("../BRRAT", repos = NULL, type = "source")
install.packages("../BRRAT", repos = NULL, type = "source")
library(BRRAT)
samples <- 30
Clim <- sort(pmax(0,rnorm(samples,600,100))) #generate some annual rainfall totals
Obs <- pmax(0,(Clim - 150) - 450 * tanh((Clim - 150)/450)) #calculate annual runoff from tanh curve
Sim1 <- Obs*seq(1,0.7,length.out=length(Obs))*rnorm(samples,1,0.05) #non-robust model, underestimate the wetter years
Sim2 <- Obs*rnorm(samples,1,0.05) #robust model, only random error
slopes1 <- BRRAT(Sim1,Obs,Clim)
unload(BRRAT)
close(BRRAT)
install.packages("../rstanlm", repos = NULL, type = "source")
install.packages("../BRRAT", repos = NULL, type = "source")
library(BRRAT)
samples <- 30
Clim <- sort(pmax(0,rnorm(samples,600,100))) #generate some annual rainfall totals
Obs <- pmax(0,(Clim - 150) - 450 * tanh((Clim - 150)/450)) #calculate annual runoff from tanh curve
Sim1 <- Obs*seq(1,0.7,length.out=length(Obs))*rnorm(samples,1,0.05) #non-robust model, underestimate the wetter years
Sim2 <- Obs*rnorm(samples,1,0.05) #robust model, only random error
slopes1 <- BRRAT(Sim1,Obs,Clim)
slopes2 <- BRRAT(Sim2,Obs,Clim)
dat <- data.frame(beta = c(slopes1$beta, slopes2$beta),
id = c(rep("Sim1",length(slopes1$beta)),
rep("Sim2",length(slopes2$beta))))
ggplot2::ggplot(dat)+geom_density(aes(beta,fill=id))
ggplot2::ggplot(dat)+ggplot2::geom_density(aes(beta,fill=id))
ggplot2::ggplot(dat)+ggplot2::geom_density(ggplot2::aes(beta,fill=id))
ggplot2::ggplot(dat)+ggplot2::geom_density(ggplot2::aes(beta,fill=id))+
ggplot2::geom_vline(xintercept=0)
samples <- 30
Clim <- sort(pmax(0,rnorm(samples,600,100))) #generate some annual rainfall totals
Obs <- pmax(0,(Clim - 150) - 450 * tanh((Clim - 150)/450)) #calculate annual runoff from tanh curve
Sim1 <- Obs*seq(1,0.7,length.out=length(Obs))*rnorm(samples,1,0.05) #non-robust model, underestimate the wetter years
Sim2 <- Obs*rnorm(samples,1,0.05) #robust model, only random error
slopes1 <- BRRAT(Sim1,Obs,Clim)
slopes2 <- BRRAT(Sim2,Obs,Clim)
dat <- data.frame(beta = c(slopes1$beta, slopes2$beta),
id = c(rep("Sim1",length(slopes1$beta)),
rep("Sim2",length(slopes2$beta))))
ggplot2::ggplot(dat)+ggplot2::geom_density(ggplot2::aes(beta,fill=id))+
ggplot2::geom_vline(xintercept=0)
samples <- 50
Clim <- sort(pmax(0,rnorm(samples,600,100))) #generate some annual rainfall totals
Obs <- pmax(0,(Clim - 150) - 450 * tanh((Clim - 150)/450)) #calculate annual runoff from tanh curve
Sim1 <- Obs*seq(1,0.7,length.out=length(Obs))*rnorm(samples,1,0.05) #non-robust model, underestimate the wetter years
Sim2 <- Obs*rnorm(samples,1,0.05) #robust model, only random error
slopes1 <- BRRAT(Sim1,Obs,Clim)
slopes2 <- BRRAT(Sim2,Obs,Clim)
dat <- data.frame(beta = c(slopes1$beta, slopes2$beta),
id = c(rep("Sim1",length(slopes1$beta)),
rep("Sim2",length(slopes2$beta))))
ggplot2::ggplot(dat)+ggplot2::geom_density(ggplot2::aes(beta,fill=id))+
ggplot2::geom_vline(xintercept=0)
samples <- 100
Clim <- sort(pmax(0,rnorm(samples,600,100))) #generate some annual rainfall totals
Obs <- pmax(0,(Clim - 150) - 450 * tanh((Clim - 150)/450)) #calculate annual runoff from tanh curve
Sim1 <- Obs*seq(1,0.7,length.out=length(Obs))*rnorm(samples,1,0.05) #non-robust model, underestimate the wetter years
Sim2 <- Obs*rnorm(samples,1,0.05) #robust model, only random error
slopes1 <- BRRAT(Sim1,Obs,Clim)
slopes2 <- BRRAT(Sim2,Obs,Clim)
dat <- data.frame(beta = c(slopes1$beta, slopes2$beta),
model = c(rep("Sim1",length(slopes1$beta)),
rep("Sim2",length(slopes2$beta))))
ggplot2::ggplot(dat)+ggplot2::geom_density(ggplot2::aes(beta,fill=model))+
ggplot2::geom_vline(xintercept=0)
samples <- 50
Clim <- sort(pmax(0,rnorm(samples,600,100))) #generate some annual rainfall totals
Obs <- pmax(0,(Clim - 150) - 450 * tanh((Clim - 150)/450)) #calculate annual runoff from tanh curve
Sim1 <- Obs*seq(1,0.7,length.out=length(Obs))*rnorm(samples,1,0.05) #non-robust model, underestimate the wetter years
Sim2 <- Obs*rnorm(samples,1,0.05) #robust model, only random error
slopes1 <- BRRAT(Sim1,Obs,Clim)
slopes2 <- BRRAT(Sim2,Obs,Clim)
dat <- data.frame(beta = c(slopes1$beta, slopes2$beta),
model = c(rep("Sim1",length(slopes1$beta)),
rep("Sim2",length(slopes2$beta))))
ggplot2::ggplot(dat)+ggplot2::geom_density(ggplot2::aes(beta,fill=model))+
ggplot2::geom_vline(xintercept=0)
dat <- data.frame(beta = c(slopes1$beta, slopes2$beta),
model = c(rep("Sim1",length(slopes1$beta)),
rep("Sim2",length(slopes2$beta))))
ggplot2::ggplot(dat)+
ggplot2::geom_density(ggplot2::aes(beta,fill=model), alpha=0.5)+
ggplot2::geom_vline(xintercept=0)
#generate 2 models of annual streamflow
samples <- 50
Clim <- sort(pmax(0,rnorm(samples,600,100))) #generate some annual rainfall totals
Obs <- pmax(0,(Clim - 150) - 450 * tanh((Clim - 150)/450)) #calculate annual runoff from tanh curve
Sim1 <- Obs*seq(1,0.7,length.out=length(Obs))*rnorm(samples,1,0.05) #non-robust model, underestimate the wetter years
Sim2 <- Obs*rnorm(samples,1,0.05) #robust model, only random error
#apply BRRAT test to both
slopes1 <- BRRAT(Sim1,Obs,Clim)
slopes2 <- BRRAT(Sim2,Obs,Clim)
#compare slopes of regression between box-cox transformed errors and climate
dat <- data.frame(beta = c(slopes1$beta, slopes2$beta),
model = c(rep("Sim1",length(slopes1$beta)),
rep("Sim2",length(slopes2$beta))))
ggplot2::ggplot(dat)+
ggplot2::geom_density(ggplot2::aes(beta,fill=model), alpha=0.5)+
ggplot2::geom_vline(xintercept=0)
ggplot2::ggplot(dat)+
ggplot2::geom_density(ggplot2::aes(beta,fill=model), alpha=0.5)+
ggplot2::geom_vline(xintercept=0, linetype="dashed")
plot(slopes1[['fit']])
print(slopes1[['fit']])
print(slopes2[['fit']])
??use_gpl3_license
usethis::use_gpl3_license()
hist(samples1[["beta"]])
samples <- 50
#generate some annual rainfall totals
Clim <- sort(pmax(0,rnorm(samples,600,100)))
#calculate annual runoff from tanh curve
Obs <- pmax(0,(Clim - 150) - 450 * tanh((Clim - 150)/450))
#non-robust model, underestimate the wetter years
Sim1 <- Obs*seq(1,0.7,length.out=length(Obs))*rnorm(samples,1,0.05)
#robust model, only random error
Sim2 <- Obs*rnorm(samples,1,0.05)
#apply BRRAT test to both
slopes1 <- BRRAT(Sim1,Obs,Clim)
slopes2 <- BRRAT(Sim2,Obs,Clim)
samples <- 50
#generate some annual rainfall totals
Clim <- sort(pmax(0,rnorm(samples,600,100)))
#calculate annual runoff from tanh curve
observed <- pmax(0,(Clim - 150) - 450 * tanh((Clim - 150)/450))
#non-robust model, underestimate the wetter years
Sim1 <- Obs*seq(1,0.7,length.out=length(Obs))*rnorm(samples,1,0.05)
samples <- 50
#generate some annual rainfall totals
Clim <- sort(pmax(0,rnorm(samples,600,100)))
#calculate annual runoff from tanh curve
observed <- pmax(0,(Clim - 150) - 450 * tanh((Clim - 150)/450))
#non-robust model, underestimate the wetter years
Sim1 <- observed*seq(1,0.7,length.out=length(Obs))*rnorm(samples,1,0.05)
samples <- 50
#generate some annual rainfall totals
Clim <- sort(pmax(0,rnorm(samples,600,100)))
#calculate annual runoff from tanh curve
observed <- pmax(0,(Clim - 150) - 450 * tanh((Clim - 150)/450))
#non-robust model, underestimate the wetter years
Sim1 <- observed*seq(1,0.7,length.out=length(observed))*rnorm(samples,1,0.05)
#robust model, only random error
Sim2 <- observed*rnorm(samples,1,0.05)
#apply BRRAT test to both
slopes1 <- BRRAT(Sim1,observed,Clim)
slopes2 <- BRRAT(Sim2,observed,Clim)
samples <- 50
#generate some annual rainfall totals
Clim <- sort(pmax(0,rnorm(samples,600,100)))
#calculate annual runoff from tanh curve
observed <- pmax(0,(Clim - 150) - 450 * tanh((Clim - 150)/450))
#non-robust model, underestimate the wetter years
Sim1 <- observed*seq(1,0.7,length.out=length(observed))*rnorm(samples,1,0.05)
#robust model, only random error
Sim2 <- observed*rnorm(samples,1,0.05)
#apply BRRAT test to both
slopes1 <- BRRAT(Sim1,observed,Clim)
slopes2 <- BRRAT(Sim2,observed,Clim)
BRRAT
out <- MASS::boxcox(stats::lm(x~1, data = data.frame(x = Obs)), plotit=FALSE)
Obs=observed
out <- MASS::boxcox(stats::lm(x~1, data = data.frame(x = Obs)), plotit=FALSE)
out
range <- range(out$x[out$y > max(out$y)-stats::qchisq(0.95,1)/2])
range
out <- MASS::boxcox(stats::lm(x~1, data = data.frame(x = Obs)))#, plotit=FALSE)
samples <- 50
#generate some annual rainfall totals
Clim <- sort(pmax(0,rnorm(samples,600,100)))
#calculate annual runoff from tanh curve
observed <- pmax(0,(Clim - 150) - 450 * tanh((Clim - 150)/450))
#non-robust model, underestimate the wetter years
Sim1 <- observed*seq(1,0.7,length.out=length(observed))*rnorm(samples,1,0.05)
#robust model, only random error
Sim2 <- observed*rnorm(samples,1,0.05)
#apply BRRAT test to both
slopes1 <- BRRAT(Sim1,observed,Clim)
slopes2 <- BRRAT(Sim2,observed,Clim)
tracaback()
traceback()
data.frame(x=observed)
stats::lm(x~1, data = data.frame(x = observed))
stats::lm(x~1, data = data.frame(x = observed))
?boxcox
df <- data.frame(x = Obs)
Obs <- observed
df <- data.frame(x = Obs)
out <- MASS::boxcox(stats::lm(x~1, data = df), plotit=FALSE)
df
dframe <- data.frame(x = Obs)
out <- MASS::boxcox(stats::lm(x~1, data = dframe), plotit=FALSE)
out
source("C:/code/BRRAT/R/BRRAT.R", echo=TRUE)
samples <- 50
#generate some annual rainfall totals
Clim <- sort(pmax(0,rnorm(samples,600,100)))
#calculate annual runoff from tanh curve
observed <- pmax(0,(Clim - 150) - 450 * tanh((Clim - 150)/450))
#non-robust model, underestimate the wetter years
Sim1 <- observed*seq(1,0.7,length.out=length(observed))*rnorm(samples,1,0.05)
#robust model, only random error
Sim2 <- observed*rnorm(samples,1,0.05)
#apply BRRAT test to both
slopes1 <- BRRAT(Sim1,observed,Clim)
slopes2 <- BRRAT(Sim2,observed,Clim)
samples <- 50
#generate some annual rainfall totals
Clim <- sort(pmax(0,rnorm(samples,600,100)))
#calculate annual runoff from tanh curve
observed <- pmax(0,(Clim - 150) - 450 * tanh((Clim - 150)/450))
#non-robust model, underestimate the wetter years
Sim1 <- observed*seq(1,0.7,length.out=length(observed))*rnorm(samples,1,0.05)
#robust model, only random error
Sim2 <- observed*rnorm(samples,1,0.05)
#apply BRRAT test to both
slopes1 <- BRRAT(Sim1,observed,Clim)
slopes2 <- BRRAT(Sim2,observed,Clim)
library(BRRAT)
samples <- 50
#generate some annual rainfall totals
Clim <- sort(pmax(0,rnorm(samples,600,100)))
#calculate annual runoff from tanh curve
observed <- pmax(0,(Clim - 150) - 450 * tanh((Clim - 150)/450))
#non-robust model, underestimate the wetter years
Sim1 <- observed*seq(1,0.7,length.out=length(observed))*rnorm(samples,1,0.05)
#robust model, only random error
Sim2 <- observed*rnorm(samples,1,0.05)
#apply BRRAT test to both
slopes1 <- BRRAT(Sim1,observed,Clim)
slopes2 <- BRRAT(Sim2,observed,Clim)
traceback()
Obs <- observed
dframe <- data.frame(x = Obs)
lm_m <- with(dframe,stats::lm(x~1))
out <- MASS::boxcox(lm_m, plotit=FALSE)
lm_m
out <- with(dframe,MASS::boxcox(stats::lm(x~1), plotit=FALSE))
dframe <- data.frame(x = Obs)
out <- with(dframe,MASS::boxcox(stats::lm(x~1), plotit=FALSE))
out <- with(dframe,MASS::boxcox(stats::lm(x~1, data=dframe), plotit=FALSE))
out
samples <- 50
#generate some annual rainfall totals
Clim <- sort(pmax(0,rnorm(samples,600,100)))
#calculate annual runoff from tanh curve
observed <- pmax(0,(Clim - 150) - 450 * tanh((Clim - 150)/450))
#non-robust model, underestimate the wetter years
Sim1 <- observed*seq(1,0.7,length.out=length(observed))*rnorm(samples,1,0.05)
#robust model, only random error
Sim2 <- observed*rnorm(samples,1,0.05)
#apply BRRAT test to both
slopes1 <- BRRAT(Sim1,observed,Clim)
slopes2 <- BRRAT(Sim2,observed,Clim)
#compare slopes of regression between box-cox transformed errors and climate
dat <- data.frame(beta = c(slopes1$beta, slopes2$beta),
model = c(rep("Sim1",length(slopes1$beta)),
rep("Sim2",length(slopes2$beta))))
ggplot2::ggplot(dat)+
ggplot2::geom_density(ggplot2::aes(beta,fill=model), alpha=0.5)+
ggplot2::geom_vline(xintercept=0, linetype="dashed")
dframe <- data.frame(x = Obs)
lm_m <- stats::lm(x~1, data=dframe)
out <- with(dframe,MASS::boxcox(lm_m, plotit=FALSE))
out
?MASS::boxcox
dframe <- data.frame(x = Obs)
Obs <- rnorm(100)
dframe <- data.frame(x = Obs)
lm_m <- stats::lm(x~1, data=dframe)
out <- MASS::boxcox(lm_m, data=dframe, plotit=FALSE))
out <- MASS::boxcox(lm_m, data=dframe, plotit=FALSE)
Obs <- lob(rnorm(100))
Obs <- log(rnorm(100))
Obs <- (rnorm(100),100,1)
Obs <- rnorm(100,100,1)
Obs
dframe <- data.frame(x = Obs)
lm_m <- stats::lm(x~1, data=dframe)
out <- MASS::boxcox(lm_m, data=dframe, plotit=FALSE)
range <- range(out$x[out$y > max(out$y)-stats::qchisq(0.95,1)/2])
range
usethis::use_package("ggplot2")
library(devtools)
devtools::release_checks()
devtools::release()
spell_check()
spell_check()
devtools::release()
check_win_devel()
check_win_release()
check_win_release()
check_rhub()
library(rhub)
rhub_setup()
pkgload::dev_help('BRRAT')
pkgload::dev_help('BRRAT')
check_win_release()
check_win_devel()
check_win_release()
